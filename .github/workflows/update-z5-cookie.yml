name: Update ZEE5 Cookie Token

on:
  schedule:
    - cron: "*/10 * * * *"  # Runs every 10 minutes
  workflow_dispatch:       # Manual trigger option

jobs:
  update-cookie:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install curl
        run: sudo apt-get install -y curl

      - name: Fetch new hdntl token from secret URL
        id: fetch_token
        env:
          Z5_SECRET_URL: ${{ secrets.Z5_SECRET_URL }}
        run: |
          echo "üîê Fetching token from secret URL..."
          TOKEN=$(curl -s -L -v "$Z5_SECRET_URL" 2>&1 | awk '/< location:/ {print $3; exit}' | grep -o 'hdntl=[^&]*')
          echo "‚úÖ New token fetched: $TOKEN"
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Replace old token in channels.json
        run: |
          echo "üîÑ Updating channels.json..."
          OLD=$(grep -o 'hdntl=[^"]*' channels.json | head -n 1)
          echo "Replacing $OLD with $TOKEN"
          sed -i "s|$OLD|$TOKEN|g" channels.json

      - name: Commit and push changes
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add channels.json
          git commit -m "üîÑ Auto-update ZEE5 token" || echo "‚ö†Ô∏è No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
